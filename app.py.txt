import streamlit as st
from langchain_community.document_loaders import PyPDFDirectoryLoader
from langchain_community.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings, ChatOpenAI
from langchain.chains import RetrievalQA
from langchain.prompts import PromptTemplate
import os
import smtplib
from email.mime.text import MIMEText

# --- 1. AYARLAR VE MARKA K襤ML襤襤 ---
st.set_page_config(page_title="Oddomatik - Ak覺ll覺 Sigorta Asistan覺", page_icon="")

# --- 2. MA襤L GNDERME S襤STEM襤 (LEAD GENERATION) ---
def mail_gonder(mesaj_icerigi):
    try:
        # BURAYI KEND襤 B襤LG襤LER襤NLE DOLDURMALISIN
        gonderici = "asistan.oddomatik@gmail.com" 
        alici = "teklif@oddomatik.com" # Tekliflerin d羹ecei mail adresi
        sifre = "xxxx xxxx xxxx xxxx" # Gmail'den al覺nacak 16 haneli uygulama ifresi
        
        msg = MIMEText(mesaj_icerigi)
        msg['Subject'] = 'Oddomatik - Yeni Fiyat Talebi!'
        msg['From'] = gonderici
        msg['To'] = alici

        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
            server.login(gonderici, sifre)
            server.send_message(msg)
        return True
    except:
        return False

# --- 3. API ANAHTARI (GVENL襤 YNTEM) ---
if "OPENAI_API_KEY" in st.secrets:
    os.environ["OPENAI_API_KEY"] = st.secrets["OPENAI_API_KEY"]
else:
    st.error("L羹tfen OpenAI API anahtar覺n覺 Streamlit Secrets alan覺na ekleyin!")

# --- 4. PDF VER襤LER襤N襤 YKLEME ---
@st.cache_resource
def verileri_yukle():
    if not os.path.exists("belgeler"):
        os.makedirs("belgeler")
    loader = PyPDFDirectoryLoader("belgeler/")
    docs = loader.load()
    if not docs:
        return None
    embeddings = OpenAIEmbeddings()
    vectorstore = FAISS.from_documents(docs, embeddings)
    return vectorstore

# --- 5. ARAYZ TASARIMI ---
st.title(" Oddomatik")
st.subheader("7/24 Ak覺ll覺 Sigorta Dan覺man覺n覺z")

# Yan Men羹 (Sidebar)
with st.sidebar:
    st.image("https://via.placeholder.com/150?text=Oddomatik", width=150) # Logo yerine ge癟er
    st.markdown("### H覺zl覺 Teklif Al")
    with st.form("iletisim"):
        tel = st.text_input("Telefon Numaran覺z")
        brans = st.selectbox("Bran", ["Kasko", "Sal覺k", "Konut", "Dier"])
        gonder = st.form_submit_button("Sizi Arayal覺m")
        if gonder and tel:
            basari = mail_gonder(f"Oddomatik 羹zerinden talep geldi!\nTel: {tel}\nBran: {brans}")
            if basari: st.success("Talebiniz iletildi!")
            else: st.warning("u an mail g繹nderilemedi, numaran覺z覺 chat'e yazabilirsiniz.")

# --- 6. SOHBET MANTII ---
if "messages" not in st.session_state:
    st.session_state.messages = []

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

if soru := st.chat_input("Oddomatik'e sorun..."):
    st.session_state.messages.append({"role": "user", "content": soru})
    with st.chat_message("user"):
        st.markdown(soru)

    # Fiyat/Teklif Kelime Kontrol羹
    fiyat_kelimeleri = ["fiyat", "teklif", "ne kadar", "ka癟 para", "hesapla"]
    if any(k in soru.lower() for k in fiyat_kelimeleri):
        cevap = "Oddomatik olarak size en uygun teklifi haz覺rlayabilmemiz i癟in l羹tfen sol taraftaki formu doldurun veya telefon numaran覺z覺 buraya yaz覺n."
    else:
        # PDF'den Bilgi ekme (RAG)
        db = verileri_yukle()
        if db:
            # Kesin Sadakat Promptu
            sablon = """Sen Oddomatik adl覺 bir sigorta uzman覺s覺n. Sadece sana verilen d繹k羹manlara g繹re cevap ver. 
            Bilgi yoksa uydurma, nazik癟e bilmediini s繹yle.
            D繹k羹manlar: {context}
            Soru: {question}
            Cevap:"""
            PROMPT = PromptTemplate(template=sablon, input_variables=["context", "question"])
            
            qa = RetrievalQA.from_chain_type(
                llm=ChatOpenAI(model_name="gpt-4o", temperature=0),
                retriever=db.as_retriever(),
                chain_type_kwargs={"prompt": PROMPT}
            )
            result = qa.invoke(soru)
            cevap = result["result"]
        else:
            cevap = "Hen羹z bilgi d繹k羹manlar覺 y羹klenmemi. L羹tfen 'belgeler' klas繹r羹ne PDF ekleyin."

    with st.chat_message("assistant"):
        st.markdown(cevap)
    st.session_state.messages.append({"role": "assistant", "content": cevap})